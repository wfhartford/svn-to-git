# SVN to Git Migration Helper Scripts

This repository consists of scripts used during the migration of many
Subversion repositories to Git. This uses the
[svn-all-fast-export](https://github.com/svn-all-fast-export/svn2git) tool
which is much faster and more flexible than git-svn, but does not support one-
or two- way synchronisation.

## Prerequisites

### SVN Repositories
This conversion requires that full SVN repositories be available on the local
file system;
[svnadmin hotcopy](http://svnbook.red-bean.com/en/1.7/svn.ref.svnadmin.c.hotcopy.html)
is a nice way to make this happen. While preparing rules, I've been working
from extracted backups. These local SVN repositories must be available in a
directory or symlink named `svn` in the same repositories as the scripts. The
`extract-repos.sh` script may be helpful, it extracts backups in a tar/bzip2
format from a directory or symlink named `local-backups`.

### Authors
In order to generate the authors file, we use the `build-authors.sh` script,
which requires a CSV file generated by the
`powershell/Export_AD_Users_to_CSV.ps1` Windows power shell script. This script
generates a CSV file with user information exported from active directory. If
this is appropriate for your environment, it will probably have to be run by a
highly privileged user. The CSV file will records with the following structure:

| First Name | Last Name | Display Name | Logon Name | Full address | Email | Account Status |
| ---------- | --------- | ------------ | ---------- | ------------ | ----- | -------------- |
| User's first name | User's last name | User's display name | User's logon name | Mailing address (ignored) | User's e-mail address | User's account status, either `Enabled` or `Disabled` (ignored) |

The `build-authors.sh` script will scan the history of all SVN repos to find
all authors through the history of your SVN repositories. This will then be
combined with the details in the active directory dump file to generate the
required `authors.txt` file which uses the following structure:

```
svn_name = Full Name <email@address.com>
```

### Migration Rules
The SVN to Git migration uses the
[svn-all-fast-export](https://github.com/svn-all-fast-export/svn2git) tool,
which requires a fair amount of configuration in rules files. See the
documentation and examples in their repository for details. For complex SVN
histories, these rules can be slow and tedious to build, I don't have any
further advice to offer here.

I recommend creating a rules file for each Git repo to be generated. If many
Git repositories are going to be built from one SVN repository, those rules
files should be included by one main rules file using the `include` directive.

In order to use the `transport-all.sh` script, rules should be organised as
follows:
* Parent directory named `rules` in the top level working copy directory,
* Sub-directories having the same name as the SVN repository,
* Rules files in the sub-directories named `main.rules`,
* If many rules files are needed, they should all be included in `main.rules`.

In order to use the included Bitbucket scripts, all repositories should be
created in a directory named `repo`. This can be accomplished simply by
prefixing the repository name with `repo/`, for example:
```
create repository repo/name
end repository

match /trunk/
 repository repo/name
 branch master
end match
```

## Migration
Once the rules file(s) have been written, the import/export process can be
started using the `transport.sh` script:
```bash
./transport.sh [SVN repository location] [rules file]
```
Depending on many factors, this may take just a few seconds or significantly
more, the larger repositories I've been working with take several hours.

Once the transport script completes successfully, you will have your Git
repositories built. Take a close look at the repositories and their history,
figure out what's wrong, adjust the rules files accordingly and do it all
again.

If many Subversion repositores are being migrated, and the rules files are laid
out as described in the previous section, the `transport-all.sh` script can be
used to perform many migrations concurrently.

## Bitbucket upload
We've decided to host our source repositories on Bitbucket Server (aka. Stash).
To that end, this repository includes a couple scripts which perform actions in
Bitbucket Server:
* `bitbucket-conf.sh` - Exports variables used by other Bitbucket scripts,
modify this script to define the server location, and project name. This script
assumes the existence of a file named `.bitbucket-token` which must contain a
personal access token. This token can be obtained from Bitbucket server and
must provide project admin rights on the project to which the Git repositories
will be uploaded.
* `bitbucket-upload.sh` - Uploads all git repos in the `repo` directory to the
configured project in the configured Bitbucket server.
* `bitbucket-delete-all-repositories.sh` - *WARNING* - Permenently deletes all
repositories from the configured Bitbucket project and server with names
matching the files and directories in the `repo` directory.
